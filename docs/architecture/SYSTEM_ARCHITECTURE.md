# 전체 시스템 아키텍처

> **문서 버전:** v1.0
> **작성일:** 2025-12-09
> **상태:** 확정

---

## 1. 시스템 개요

### 1.1 전체 아키텍처 다이어그램

```
┌────────────────────────────────────────────────────────────────────────────┐
│                           김치프리미엄 헷지 시스템                           │
├────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         외부 거래소 API                              │   │
│  │  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐          │   │
│  │  │   Upbit      │    │   BingX      │    │   Bybit      │          │   │
│  │  │  (현물)      │    │  (선물)      │    │  (선물)      │          │   │
│  │  │  BTC/KRW     │    │ BTCUSDT Perp │    │ BTCUSDT Perp │          │   │
│  │  └──────┬───────┘    └──────┬───────┘    └──────┬───────┘          │   │
│  └─────────┼────────────────────┼────────────────────┼─────────────────┘   │
│            │                    │                    │                      │
│            │ REST/WS            │ REST/WS            │ REST/WS (추후)       │
│            ▼                    ▼                    ▼                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         서버 레이어                                  │   │
│  │                                                                      │   │
│  │  ┌────────────────────────┐    ┌────────────────────────┐          │   │
│  │  │     김프 서버           │    │     인증 서버           │          │   │
│  │  │   (Kimchi Server)      │    │   (Auth Server)        │          │   │
│  │  │                        │    │                        │          │   │
│  │  │  • 시세 수집            │    │  • 로그인/토큰          │          │   │
│  │  │  • 환율 계산            │    │  • 라이센스 관리        │          │   │
│  │  │  • 김프 계산 (1초)      │    │  • HWID 검증           │          │   │
│  │  │  • WebSocket 브로드캐스트│    │  • 관리자 API          │          │   │
│  │  └───────────┬────────────┘    └───────────┬────────────┘          │   │
│  │              │                              │                        │   │
│  │              │ WebSocket                    │ HTTPS                  │   │
│  │              │ (김프 데이터)                │ (인증)                  │   │
│  └──────────────┼──────────────────────────────┼────────────────────────┘   │
│                 │                              │                            │
│                 ▼                              ▼                            │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      클라이언트 (WPF EXE)                            │   │
│  │                                                                      │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │   │
│  │  │   UI Layer   │  │   Service    │  │    Core      │              │   │
│  │  │              │  │   Layer      │  │   Layer      │              │   │
│  │  │  • 메인 화면  │  │              │  │              │              │   │
│  │  │  • 설정 화면  │  │  • 인증      │  │  • 트레이딩   │              │   │
│  │  │  • 로그 뷰어  │  │  • 김프 수신  │  │  • 포지션    │              │   │
│  │  │  • 트레이    │  │  • 거래소 API │  │  • 손익 계산  │              │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘              │   │
│  │                                                                      │   │
│  │                    ┌──────────────┐                                 │   │
│  │                    │   Security   │                                 │   │
│  │                    │   Layer      │                                 │   │
│  │                    │  • AES-256   │                                 │   │
│  │                    │  • HWID      │                                 │   │
│  │                    └──────────────┘                                 │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         데이터 저장소                                │   │
│  │  ┌──────────────┐                      ┌──────────────┐            │   │
│  │  │   Server DB  │                      │   Local DB   │            │   │
│  │  │  (PostgreSQL)│                      │   (SQLite)   │            │   │
│  │  │  • Users     │                      │  • Settings  │            │   │
│  │  │  • Licenses  │                      │  • Logs      │            │   │
│  │  │  • AuditLogs │                      │  • API Keys  │            │   │
│  │  └──────────────┘                      │    (암호화)  │            │   │
│  │                                        └──────────────┘            │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 컴포넌트 상세

### 2.1 서버 컴포넌트

#### 2.1.1 김프 서버 (Kimchi Server)

| 항목 | 설명 |
|------|------|
| 역할 | 실시간 김치프리미엄 계산 및 배포 |
| 기술 | C# ASP.NET Core + WebSocket |
| 포트 | 443 (WSS) |
| 주기 | 1초 |

**기능:**
- 업비트 BTC/KRW 시세 수집 (WebSocket)
- BingX BTCUSDT 시세 수집 (WebSocket)
- 환율 정보 수집 (USD/KRW)
- 김치프리미엄 계산
- 클라이언트에 브로드캐스트

**김프 계산 공식:**
```
김치프리미엄(%) = ((업비트가격 / (해외가격 × 환율)) - 1) × 100
```

#### 2.1.2 인증 서버 (Auth Server)

| 항목 | 설명 |
|------|------|
| 역할 | 사용자 인증 및 라이센스 관리 |
| 기술 | C# ASP.NET Core + REST API |
| 포트 | 443 (HTTPS) |

**기능:**
- 회원가입/로그인
- JWT 토큰 발급/갱신
- 라이센스 상태 관리
- HWID 검증
- 관리자 API

### 2.2 클라이언트 컴포넌트

#### 2.2.1 레이어 구조

```
┌─────────────────────────────────────────────────────┐
│                    UI Layer (WPF)                   │
│  ┌───────────────────────────────────────────────┐ │
│  │ Views (XAML)          ViewModels (MVVM)       │ │
│  │ • MainWindow          • MainViewModel         │ │
│  │ • LoginView           • LoginViewModel        │ │
│  │ • SettingsView        • SettingsViewModel     │ │
│  │ • LogView             • LogViewModel          │ │
│  └───────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────┤
│                  Service Layer                      │
│  ┌───────────────────────────────────────────────┐ │
│  │ • AuthService         - 인증 처리             │ │
│  │ • KimchiService       - 김프 데이터 수신      │ │
│  │ • UpbitService        - 업비트 API            │ │
│  │ • BingXService        - BingX API             │ │
│  │ • NotificationService - 알림                  │ │
│  └───────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────┤
│                   Core Layer                        │
│  ┌───────────────────────────────────────────────┐ │
│  │ • TradingEngine       - 자동매매 엔진         │ │
│  │ • PositionManager     - 포지션 관리           │ │
│  │ • OrderExecutor       - 주문 실행             │ │
│  │ • PnLCalculator       - 손익 계산             │ │
│  │ • RollbackHandler     - 롤백 처리             │ │
│  └───────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────┤
│                 Security Layer                      │
│  ┌───────────────────────────────────────────────┐ │
│  │ • CryptoService       - AES-256 암호화        │ │
│  │ • HwidGenerator       - HWID 생성             │ │
│  │ • SecureStorage       - 안전한 저장소         │ │
│  │ • TokenManager        - 토큰 관리             │ │
│  └───────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────┤
│               Infrastructure Layer                  │
│  ┌───────────────────────────────────────────────┐ │
│  │ • HttpClientFactory   - HTTP 클라이언트       │ │
│  │ • WebSocketClient     - WebSocket 클라이언트  │ │
│  │ • LocalDatabase       - SQLite                │ │
│  │ • Logger              - 로깅                  │ │
│  └───────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────┘
```

---

## 3. 데이터 흐름

### 3.1 로그인 흐름

```
┌─────────┐     ┌─────────────┐     ┌─────────────┐
│  User   │     │   Client    │     │ Auth Server │
└────┬────┘     └──────┬──────┘     └──────┬──────┘
     │                 │                    │
     │ 이메일/비밀번호  │                    │
     │────────────────►│                    │
     │                 │                    │
     │                 │ HWID 생성          │
     │                 │────────┐           │
     │                 │◄───────┘           │
     │                 │                    │
     │                 │ POST /auth/login   │
     │                 │───────────────────►│
     │                 │                    │
     │                 │ JWT Token          │
     │                 │◄───────────────────│
     │                 │                    │
     │                 │ 토큰 메모리 저장    │
     │                 │────────┐           │
     │                 │◄───────┘           │
     │                 │                    │
     │ 메인 화면 표시   │                    │
     │◄────────────────│                    │
```

### 3.2 자동매매 흐름

```
┌─────────────┐   ┌─────────────┐   ┌─────────────┐   ┌─────────────┐
│Kimchi Server│   │   Client    │   │   Upbit     │   │   BingX     │
└──────┬──────┘   └──────┬──────┘   └──────┬──────┘   └──────┬──────┘
       │                 │                 │                 │
       │ kimchi: 3.21%   │                 │                 │
       │────────────────►│                 │                 │
       │                 │                 │                 │
       │                 │ 조건 비교        │                 │
       │                 │ (진입값 3.0%)    │                 │
       │                 │────────┐        │                 │
       │                 │◄───────┘        │                 │
       │                 │                 │                 │
       │                 │ 진입 조건 충족!  │                 │
       │                 │                 │                 │
       │                 │ 시장가 매수      │                 │
       │                 │────────────────►│                 │
       │                 │                 │                 │
       │                 │ 체결 완료        │                 │
       │                 │ (0.01 BTC)      │                 │
       │                 │◄────────────────│                 │
       │                 │                 │                 │
       │                 │ 시장가 숏        │                 │
       │                 │ (0.01 BTC)      │                 │
       │                 │─────────────────┼────────────────►│
       │                 │                 │                 │
       │                 │                 │   체결 완료      │
       │                 │◄────────────────┼─────────────────│
       │                 │                 │                 │
       │                 │ 포지션 저장      │                 │
       │                 │ (1:1 헷지 완료)  │                 │
```

### 3.3 익절/손절 흐름

```
┌─────────────┐   ┌─────────────┐   ┌─────────────┐   ┌─────────────┐
│Kimchi Server│   │   Client    │   │   Upbit     │   │   BingX     │
└──────┬──────┘   └──────┬──────┘   └──────┬──────┘   └──────┬──────┘
       │                 │                 │                 │
       │ kimchi: 1.5%    │                 │                 │
       │────────────────►│                 │                 │
       │                 │                 │                 │
       │                 │ 조건 비교        │                 │
       │                 │ (익절값 2.0%)    │                 │
       │                 │────────┐        │                 │
       │                 │◄───────┘        │                 │
       │                 │                 │                 │
       │                 │ 익절 조건 충족!  │                 │
       │                 │                 │                 │
       │                 │ 전량 시장가 매도 │                 │
       │                 │────────────────►│                 │
       │                 │                 │                 │
       │                 │ 숏 전량 청산    │                 │
       │                 │─────────────────┼────────────────►│
       │                 │                 │                 │
       │                 │     동시 체결    │                 │
       │                 │◄────────────────┼─────────────────│
       │                 │                 │                 │
       │                 │ 손익 계산        │                 │
       │                 │ 쿨다운 시작      │                 │
       │                 │────────┐        │                 │
       │                 │◄───────┘        │                 │
```

---

## 4. 거래소 추상화

### 4.1 인터페이스 설계

```csharp
// 현물 거래소 인터페이스
public interface ISpotExchange
{
    string Name { get; }
    Task<decimal> GetBalanceAsync(string asset);
    Task<OrderResult> PlaceMarketBuyAsync(string symbol, decimal quoteAmount);
    Task<OrderResult> PlaceMarketSellAsync(string symbol, decimal baseAmount);
    Task<OrderResult> GetOrderAsync(string orderId);
    Task SubscribeToTradesAsync(string symbol, Action<Trade> onTrade);
}

// 선물 거래소 인터페이스
public interface IFuturesExchange
{
    string Name { get; }
    Task<decimal> GetBalanceAsync();
    Task<Position?> GetPositionAsync(string symbol);
    Task<OrderResult> OpenShortAsync(string symbol, decimal amount, int leverage);
    Task<OrderResult> ClosePositionAsync(string symbol);
    Task SubscribeToTradesAsync(string symbol, Action<Trade> onTrade);
}

// 거래소 팩토리
public interface IExchangeFactory
{
    ISpotExchange CreateSpotExchange(ExchangeType type, ApiCredentials credentials);
    IFuturesExchange CreateFuturesExchange(ExchangeType type, ApiCredentials credentials);
}
```

### 4.2 지원 거래소

```csharp
public enum ExchangeType
{
    // 현물
    Upbit,

    // 선물
    BingX,
    Bybit  // 추후 확장
}
```

---

## 5. 상태 관리

### 5.1 시스템 상태

```csharp
public enum SystemState
{
    Initializing,     // 초기화 중
    Authenticating,   // 인증 중
    Connecting,       // 서버 연결 중
    Ready,            // 준비 완료 (대기 상태)
    Trading,          // 트레이딩 활성화
    InPosition,       // 포지션 보유 중
    Closing,          // 청산 중
    Cooldown,         // 쿨다운 중
    Error,            // 오류 상태
    Offline           // 오프라인
}
```

### 5.2 상태 전이 다이어그램

```
                    ┌──────────────┐
                    │ Initializing │
                    └──────┬───────┘
                           │
                           ▼
                    ┌──────────────┐
                    │Authenticating│──────► Error
                    └──────┬───────┘          │
                           │                  │
                           ▼                  │
                    ┌──────────────┐          │
                    │  Connecting  │──────────┤
                    └──────┬───────┘          │
                           │                  │
                           ▼                  │
                    ┌──────────────┐          │
              ┌────►│    Ready     │◄─────────┤
              │     └──────┬───────┘          │
              │            │                  │
              │            ▼                  │
              │     ┌──────────────┐          │
              │     │   Trading    │──────────┤
              │     └──────┬───────┘          │
              │            │                  │
              │            ▼                  │
              │     ┌──────────────┐          │
              │     │ InPosition   │──────────┤
              │     └──────┬───────┘          │
              │            │                  │
              │            ▼                  │
              │     ┌──────────────┐          │
              │     │   Closing    │──────────┘
              │     └──────┬───────┘
              │            │
              │            ▼
              │     ┌──────────────┐
              └─────│   Cooldown   │
                    └──────────────┘
```

---

## 6. 에러 처리

### 6.1 에러 카테고리

| 카테고리 | 처리 방식 |
|----------|-----------|
| 네트워크 오류 | 자동 재연결 (최대 5회) |
| 인증 오류 | 재로그인 요청 |
| 거래소 API 오류 | 재시도 또는 롤백 |
| 주문 실패 | 롤백 및 알림 |
| 동기화 실패 | 강제 동기화 또는 롤백 |

### 6.2 롤백 정책

```csharp
public class RollbackPolicy
{
    // 업비트 매수 성공, BingX 숏 실패 시
    // → 업비트 전량 매도로 롤백

    // 체결 수량 불일치 시
    // → 재시도 3회
    // → 실패 시 전체 롤백

    // 익절/손절 중 실패 시
    // → 재시도 3회
    // → 실패 시 수동 개입 알림
}
```

---

## 7. 보안 아키텍처

### 7.1 보안 레이어

```
┌─────────────────────────────────────────────────────┐
│                   Application                        │
├─────────────────────────────────────────────────────┤
│                                                      │
│  ┌──────────────┐    ┌──────────────┐              │
│  │  API Keys    │    │   Config     │              │
│  │  (평문)      │    │   (평문)     │              │
│  └──────┬───────┘    └──────┬───────┘              │
│         │                   │                       │
│         ▼                   ▼                       │
│  ┌─────────────────────────────────────────┐       │
│  │           AES-256 암호화 레이어          │       │
│  └─────────────────────────────────────────┘       │
│         │                   │                       │
│         ▼                   ▼                       │
│  ┌──────────────┐    ┌──────────────┐              │
│  │  API Keys    │    │   Config     │              │
│  │  (암호화)    │    │   (암호화)   │              │
│  └──────┬───────┘    └──────┬───────┘              │
│         │                   │                       │
│         ▼                   ▼                       │
│  ┌─────────────────────────────────────────┐       │
│  │           DPAPI 보호 레이어             │       │
│  │         (Windows 사용자별 암호화)        │       │
│  └─────────────────────────────────────────┘       │
│         │                   │                       │
│         ▼                   ▼                       │
│  ┌─────────────────────────────────────────┐       │
│  │              파일 시스템                 │       │
│  │         (권한 제한된 폴더)               │       │
│  └─────────────────────────────────────────┘       │
│                                                      │
└─────────────────────────────────────────────────────┘
```

---

## 8. 배포 아키텍처

### 8.1 배포 구성

```
┌─────────────────────────────────────────────────────────┐
│                      Cloud (AWS/Azure)                  │
│                                                         │
│  ┌───────────────────────────────────────────────────┐ │
│  │                  Load Balancer                     │ │
│  │                    (HTTPS)                         │ │
│  └───────────────────────┬───────────────────────────┘ │
│                          │                              │
│         ┌────────────────┼────────────────┐            │
│         │                │                │            │
│         ▼                ▼                ▼            │
│  ┌────────────┐   ┌────────────┐   ┌────────────┐     │
│  │Auth Server │   │Auth Server │   │Kimchi Server│     │
│  │  (인스턴스1)│   │  (인스턴스2)│   │             │     │
│  └─────┬──────┘   └─────┬──────┘   └─────┬──────┘     │
│        │                │                │             │
│        └────────────────┼────────────────┘             │
│                         │                              │
│                         ▼                              │
│              ┌────────────────────┐                    │
│              │   PostgreSQL DB    │                    │
│              │     (Primary)      │                    │
│              └─────────┬──────────┘                    │
│                        │                               │
│                        ▼                               │
│              ┌────────────────────┐                    │
│              │   PostgreSQL DB    │                    │
│              │     (Replica)      │                    │
│              └────────────────────┘                    │
│                                                         │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│                    사용자 PC (Windows)                   │
│                                                         │
│  ┌───────────────────────────────────────────────────┐ │
│  │                  KimchiHedge.exe                   │ │
│  │                    (WPF 클라이언트)                 │ │
│  └───────────────────────────────────────────────────┘ │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## 9. 기술 스택 요약

| 영역 | 기술 |
|------|------|
| **클라이언트** | |
| 언어 | C# (.NET 8) |
| UI | WPF (XAML, MVVM) |
| DI | Microsoft.Extensions.DependencyInjection |
| HTTP | HttpClient, System.Net.WebSockets |
| 로컬 DB | SQLite (EF Core) |
| 로깅 | Serilog |
| **서버** | |
| 프레임워크 | ASP.NET Core 8 |
| 실시간 | WebSocket / SignalR |
| 인증 | JWT Bearer |
| ORM | Entity Framework Core |
| DB | PostgreSQL |
| **공통** | |
| 암호화 | AES-256 (System.Security.Cryptography) |
| 직렬화 | System.Text.Json |
| 테스트 | xUnit, Moq |
